name: Shawon-Tailscale
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Configure RDP and Create Admin User
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Create User: Shawon
          $Password = ConvertTo-SecureString "Shawon@2025!" -AsPlainText -Force
          New-LocalUser "Shawon" -Password $Password -FullName "Shawon Admin"
          Add-LocalGroupMember -Group "Administrators" -Member "Shawon"
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
          Write-Host "RDP Configuration Complete."

      - name: Get Connection Details
        run: |
          Write-Host "=============================================================="
          Write-Host "            RDP CONNECTION DETAILS (TAILSCALE)"
          Write-Host "=============================================================="
          Write-Host "Username: Shawon"
          Write-Host "Password: Shawon@2025!"
          Write-Host "Connect to this IP:"
          tailscale ip -4
          Write-Host "=============================================================="

      - name: Keep Alive (Loop)
        run: |
          # Keeps the machine running for 6 hours
          $timeout = New-TimeSpan -Hours 6
          $source = [System.Threading.CancellationTokenSource]::new()
          Write-Host "Runner is active. You can connect now."
          Start-Sleep -Seconds 21600
          Write-Host "======================================================================"
          Write-Host "Username:    shawon (Administrator)"
          Write-Host "Password:    123456"
          Write-Host "Please find the RDP Address in the ngrok logs below."
          Write-Host "======================================================================"
          .\ngrok\ngrok.exe tcp 3389 --log=stdout
