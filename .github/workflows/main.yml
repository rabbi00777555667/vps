name: Windows-RDP-Tailscale
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Install Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /qn /norestart" -Wait

      - name: Connect to Tailscale
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_KEY --accept-routes
          Write-Host "Connected to Tailscale Mesh Network."

      - name: Enable RDP and Setup User
        shell: powershell
        run: |
          # Enable RDP in Registry
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          
          # Create Admin User
          $Password = ConvertTo-SecureString "Shawon@2025!" -AsPlainText -Force
          New-LocalUser "Shawon" -Password $Password -FullName "Shawon Admin"
          Add-LocalGroupMember -Group "Administrators" -Member "Shawon"
          Write-Host "User 'Shawon' created with password 'Shawon@2025!'"

      - name: Connection Info
        shell: powershell
        run: |
          $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          Write-Host "=========================================="
          Write-Host "IP ADDRESS: $ip"
          Write-Host "USERNAME:   Shawon"
          Write-Host "PASSWORD:   Shawon@2025!"
          Write-Host "=========================================="

      - name: Keep Alive (6 Hours)
        shell: powershell
        run: |
          $totalMinutes = 360
          for ($i=1; $i -le $totalMinutes; $i++) {
              Write-Host "RDP Active... Minute $i of $totalMinutes"
              Start-Sleep -Seconds 60
          }
          Write-Host "Password: Shawon@2025!"
          Write-Host "Connect to this IP:"
          tailscale ip -4
          Write-Host "=============================================================="

      - name: Keep Alive (Loop)
        run: |
          # Keeps the machine running for 6 hours
          $timeout = New-TimeSpan -Hours 6
          $source = [System.Threading.CancellationTokenSource]::new()
          Write-Host "Runner is active. You can connect now."
          Start-Sleep -Seconds 21600
          Write-Host "======================================================================"
          Write-Host "Username:    shawon (Administrator)"
          Write-Host "Password:    123456"
          Write-Host "Please find the RDP Address in the ngrok logs below."
          Write-Host "======================================================================"
          .\ngrok\ngrok.exe tcp 3389 --log=stdout
